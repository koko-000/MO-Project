<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üìãMO Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
/* ---------- General ---------- */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding-top: 80px; /* Top Bar height */
}

/* ---------- Top Bar ---------- */
.bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    background: #2c88ff;
    color: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 999;
}

.bar h2 {
    margin: 0;
}

.bar-logo {
    height: 60px;
}

/* ---------- Section Bar ---------- */
.sectionbar-wrapper {
    position: sticky;
    top: 70px; /* ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ Top Bar */
    z-index: 998;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    padding: 5px 0;
}

.sectionbar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 10px;
    flex-wrap: nowrap;
    white-space: nowrap;
    overflow-x: auto; /* scroll ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô sectionbar */
}

.sectionbar select,
.sectionbar input {
    border-radius: 4px;
    padding: 4px 8px;
}

.sectionbar .search-box {
    margin-left: auto;
    display: flex;
    align-items: center;
}

/* ---------- Summary ---------- */
.summary-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
  background: #fff;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  margin-top: 5px;
}

.summary-box {
    background: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #000000;
    font-weight: bold;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* ---------- Table ---------- */
.table-container {
    overflow-x: auto; /* scroll ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
}

table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
}

th, td {
    border: 1px solid #ddd;
    padding: 6px;
    font-size: 14px;
}

th {
    background: #2c88ff;
    color: white;
}

tr:nth-child(even) {
    background: #f0f8ff;
}

tr:hover {
    background: #e9e9e9;
}

.highlight {
    background-color: yellow;
    font-weight: bold;
}

/* ---------- Buttons ---------- */
button {
    padding: 5px 10px;
    border-radius: 4px;
    border: none;
    background: #2c88ff;
    color: white;
    cursor: pointer;
}

button:hover {
    background: #1860c0;
}
</style>
</head>

<body>
<!-- ---------- Top Bar ---------- -->
<div class="bar">
    <h2>üóÇÔ∏èMO DashboardüìãüìùüóíÔ∏èüììüìíüìîüìöüìñ</h2>
    <img src="{{ url_for('static', filename='MinebeaMitsumi.png') }}" alt="Logo" class="bar-logo">
</div>

<!-- ---------- Section Bar + Summary ---------- -->
<div class="sectionbar-wrapper">
    <div class="sectionbar">
        <!-- Filters -->
        <label for="DO">üìíDO:</label>
        <select id="DO"><option value="">--NONE--</option></select>

        <label for="MO">üìãMO:</label>
        <select id="MO"><option value="">--NONE--</option></select>

        <label for="dateColumn">üìùTrace From:</label>
        <select id="dateColumn"><option value="">--NONE--</option></select>

        <label for="traceBy">üóíÔ∏èTrace By:</label>
        <select id="traceBy"><option value="">--NONE--</option></select>
        <select id="traceByValue"><option value="">--Select Value--</option></select>

        üìÖ
        <input type="date" id="dateStart">
        <input type="date" id="dateEnd">
        <button id="applyBtn">Apply Filters</button>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîçSearch...">
        </div>
    </div>
    <!-- Summary -->
    <div id="summaryBar" class="summary-bar"></div>
</div>

<!-- ---------- Table ---------- -->
<div class="table-container">
    <table id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
let rawData = [];
let filteredData = [];

/* ---------- Load CSV ---------- */
Papa.parse("{{ url_for('static', filename='Maindata.csv') }}", {
    download: true,
    header: true,
    complete: function(results) {
        rawData = results.data;
        filteredData = rawData;
        renderDateOptions(results.meta.fields);
        renderTraceByColumns(filteredData, "");
        renderDOOptions(filteredData);
        renderMOOptions(filteredData);
        renderTable(filteredData);
    }
});

/* ---------- Render & Filter Functions ---------- */
function renderDateOptions(columns){
    const dateSelect = document.getElementById("dateColumn");
    dateSelect.innerHTML = `<option value="">--NONE--</option>`;
    columns.filter(col => col.toUpperCase().includes("DATE"))
           .forEach(col => {
               const opt = document.createElement("option");
               opt.value = col;
               opt.textContent = col;
               dateSelect.appendChild(opt);
           });
}

function renderTraceByColumns(data, dateCol){
    const traceBySelect = document.getElementById("traceBy");
    traceBySelect.innerHTML = `<option value="">--NONE--</option>`;
    if(data.length === 0) return;

    let columns = Object.keys(data[0]);
    let startKey=null, endKey=null;

    if(dateCol==="INV DATE") startKey="INVOICE", endKey="OPERATOR NAME";
    else if(dateCol==="QA DATE") startKey="QA/FN NO.", endKey="OPERATOR NAME_1";
    else if(dateCol==="ISS DATE") startKey="M/O NO.", endKey="OPERATOR NAME_2";
    else if(dateCol==="ISS DATE_1") startKey="LEVEL", endKey="OPERATOR NAME_3";
    else if(dateCol==="PRO DATE") startKey="NO.", endKey="OPERATOR NAME_4";

    if(startKey && endKey) columns = getColumnsBetween(Object.keys(data[0]), startKey, endKey);

    const traceable = columns.filter(c => 
        c.includes("ITEM NO.") || c.includes("REF NO.") || c.includes("OPERATOR NAME")
    );

    traceable.forEach(col => {
        const opt = document.createElement("option");
        opt.value = col;
        opt.textContent = col;
        traceBySelect.appendChild(opt);
    });
}

function renderTraceByOptions(data, column){
    const traceByValueSelect = document.getElementById("traceByValue");
    traceByValueSelect.innerHTML = `<option value="">--Select Value--</option>`;
    if(!column || data.length===0) return;

    const dateCol = document.getElementById("dateColumn").value;
    let uniqueValues = [];

    if(column === "OPERATOR NAME") {
        if(dateCol === "INV DATE") uniqueValues = data.map(d=>d["OPERATOR NAME"]);
        else if(dateCol === "PRO DATE") uniqueValues = data.map(d=>d["OPERATOR NAME_4"]);
    } else uniqueValues = data.map(d=>d[column]);

    uniqueValues = [...new Set(uniqueValues.filter(v=>v && v.trim()))].sort();
    uniqueValues.forEach(val=>{
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        traceByValueSelect.appendChild(opt);
    });
}

function renderDOOptions(data){
    const doSelect = document.getElementById("DO");
    doSelect.innerHTML = `<option value="">--NONE--</option>`;
    const uniqueDO = [...new Set(data.map(d => d["INVOICE"]).filter(v => v && v.trim()))].sort();
    uniqueDO.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        doSelect.appendChild(opt);
    });
}

function renderMOOptions(data){
    const moSelect = document.getElementById("MO");
    moSelect.innerHTML = `<option value="">--NONE--</option>`;
    const uniqueMO = [...new Set(data.map(d => d["M/O NO."]).filter(v => v && v.trim()))].sort();
    uniqueMO.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        moSelect.appendChild(opt);
    });
}

/* ---------- Event Listeners ---------- */
document.getElementById("traceBy").addEventListener("change", function(){
    const col = this.value;
    if(col) renderTraceByOptions(filteredData, col);
    else document.getElementById("traceByValue").innerHTML = `<option value="">--Select Value--</option>`;
});
document.getElementById("applyBtn").addEventListener("click", applyFilters);
document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("dateColumn").addEventListener("change", function(){
    renderTraceByColumns(filteredData, this.value);
    document.getElementById("traceBy").value = "";
    document.getElementById("traceByValue").innerHTML=`<option value="">--Select Value--</option>`;
    applyFilters();
});
document.getElementById("traceByValue").addEventListener("change", applyFilters);
document.getElementById("dateStart").addEventListener("change", applyFilters);
document.getElementById("dateEnd").addEventListener("change", applyFilters);
document.getElementById("DO").addEventListener("change", applyFilters);
document.getElementById("MO").addEventListener("change", applyFilters);

/* ---------- Filter / Table Functions ---------- */
function parseDateDMY(dateStr){
    if(!dateStr) return null;
    if(dateStr.includes('/')){ const p=dateStr.split('/'); return new Date(p[2], p[1]-1, p[0]); }
    else if(dateStr.includes('-')){ const p=dateStr.split('-'); return new Date(p[0], p[1]-1, p[2]); }
    return null;
}

function inRange(dateStr,start,end){
    const d = parseDateDMY(dateStr);
    if(!d) return false;
    if(start && d<start) return false;
    if(end && d>end) return false;
    return true;
}

function applyFilters(){
    const col = document.getElementById("dateColumn").value;
    const start = parseDateDMY(document.getElementById("dateStart").value);
    const end   = parseDateDMY(document.getElementById("dateEnd").value);
    const traceCol = document.getElementById("traceBy").value;
    const traceVal = document.getElementById("traceByValue").value;
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const doVal = document.getElementById("DO").value;
    const moVal = document.getElementById("MO").value;

    let tempData = rawData;
    if(col && (start||end)) tempData = tempData.filter(d=>inRange(d[col],start,end));
    if(traceCol && traceVal) tempData = tempData.filter(d=>d[traceCol]===traceVal);
    if(doVal) tempData = tempData.filter(d=>d["INVOICE"]===doVal);
    if(moVal) tempData = tempData.filter(d=>d["M/O NO."]===moVal);
    if(searchTerm) tempData = tempData.filter(d=>Object.values(d).some(v=>(v||'').toLowerCase().includes(searchTerm)));

    filteredData = tempData;
    renderTable(filteredData, col);

    renderTraceByColumns(filteredData, col);
    document.getElementById("traceBy").value = traceCol;
    if(traceCol) renderTraceByOptions(filteredData, traceCol);
    document.getElementById("traceByValue").value = traceVal;
    document.getElementById("DO").value = doVal;
    document.getElementById("MO").value = moVal;
}

function highlightText(text, searchTerm){
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, `<span class="highlight">$1</span>`);
}

function renderTable(data, dateCol){
    const table = document.getElementById("dataTable");
    table.innerHTML = "";
    if(data.length===0){ 
        table.innerHTML="<tr><td colspan='100%'>NO DATA</td></tr>"; 
        document.getElementById("summaryBar").innerHTML=""; 
        return; 
    }

    let columns = Object.keys(data[0]);
    let startKey=null, endKey=null;

    if(dateCol==="INV DATE") startKey="INVOICE", endKey="OPERATOR NAME";
    else if(dateCol==="QA DATE") startKey="QA/FN NO.", endKey="OPERATOR NAME_1";
    else if(dateCol==="ISS DATE") startKey="M/O NO.", endKey="OPERATOR NAME_2";
    else if(dateCol==="ISS DATE_1") startKey="LEVEL", endKey="OPERATOR NAME_3";
    else if(dateCol==="PRO DATE") startKey="NO.", endKey="OPERATOR NAME_4";

    if(startKey && endKey) columns = getColumnsBetween(Object.keys(data[0]), startKey, endKey);

    const fixedCols = [];
    if(Object.keys(data[0]).includes("INVOICE")) fixedCols.push("INVOICE");
    if(Object.keys(data[0]).includes("M/O NO.")) fixedCols.push("M/O NO.");
    const otherCols = columns.filter(c => !fixedCols.includes(c));
    columns = fixedCols.concat(otherCols);

    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    columns.forEach(col=>{
        const th = document.createElement("th"); 
        th.textContent = col; 
        headerRow.appendChild(th); 
    });
    thead.appendChild(headerRow); 
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    let firstMatchRow = null;

    data.forEach(row=>{
        const tr = document.createElement("tr");
        columns.forEach(col=>{
            const td = document.createElement("td");
            let value = row[col] || "";
            if(searchTerm && value.toLowerCase().includes(searchTerm)){
                td.innerHTML = highlightText(value, searchTerm);
                if(!firstMatchRow) firstMatchRow = tr;
            } else {
                td.textContent = value;
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    renderSummary(data);

    if(firstMatchRow){
        firstMatchRow.scrollIntoView({ behavior: "smooth", block: "center" });
    }
}

function renderSummary(data){
    const sumCols = ["INV QTY.","QTY.","QTY._1","QTY._2","IN QTY.","GOOD QTY.","NG QTY."];
    let totals = {};
    sumCols.forEach(c => totals[c] = 0);
    data.forEach(row => sumCols.forEach(c => totals[c]+=parseFloat(row[c])||0));

    const summaryBar = document.getElementById("summaryBar");
    summaryBar.innerHTML = "";
    sumCols.forEach(col=>{
        const box = document.createElement("span");
        box.className = "summary-box";
        box.textContent = `${col}: ${totals[col].toLocaleString()}`;
        if(col==="IN QTY.") box.style.color="blue";
        if(col==="GOOD QTY.") box.style.color="limegreen";
        if(col==="NG QTY." && totals[col]>0) box.style.color="red";
        summaryBar.appendChild(box);
    });
}

function getColumnsBetween(all, start, end){
    const s = all.indexOf(start), e = all.indexOf(end);
    return s===-1||e===-1 ? [] : all.slice(s, e+1);
}

// Sync scroll SectionBar ‡∏Å‡∏±‡∏ö Table Container
const sectionBarWrapper = document.querySelector('.sectionbar-wrapper');
const tableContainer = document.querySelector('.table-container');

tableContainer.addEventListener('scroll', () => {
    sectionBarWrapper.scrollLeft = tableContainer.scrollLeft;
});
</script>
</body>
</html>
